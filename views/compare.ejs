<!DOCTYPE html>
<html lang="fr">
<head>
    <%- include('partials/header') %>
    <title><%= title %></title>
</head>
<body>
    <div class="container-fluid">
        <header class="my-4 text-center">
            <h1><%= title %></h1>
            <p class="lead">Résultats de la réconciliation entre les fichiers</p>
            <div class="d-flex justify-content-center">
                <span class="badge bg-primary me-2">Fichier Fournisseur: <%= fileAName %></span>
                <span class="badge bg-secondary">Fichier SEGUCE RDC: <%= fileBName %></span>
            </div>
        </header>
        <% if (isUpdate) { %>
   <div class="alert alert-warning mt-4">
       <i class="bi bi-exclamation-triangle-fill me-2"></i>
       <strong>Fichier mis à jour !</strong> 
       Les fichiers ont été mis à jour. 
       <span class="badge bg-warning text-dark ms-2">Fichier Fournisseur: v<%= fileAVersion %></span>
       <span class="badge bg-warning text-dark ms-2">Fichier SEGUCE RDC: v<%= fileBVersion %></span>
   </div>
<% } %>

<% if (providerType === 'ancien') { %>
   <div class="alert alert-info mt-4">
       <i class="bi bi-info-circle-fill me-2"></i>
       Ce fichier provient de l'ancien prestataire. La comparaison se fera uniquement sur les colonnes communes.
   </div>
<% } %>

        <!-- Tableau de synthèse -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header bg-dark text-white">
                        <h3 class="card-title mb-0">Synthèse globale</h3>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h4 class="text-primary mb-3">Informations générales</h4>
                                <table class="table table-bordered table-striped">
                                <tbody>
    <tr>
        <th>Nombre de lignes (Fichier Fournisseur)</th>
        <td><%= comparisonResult.summary.totalRows.fileA %></td>
    </tr>
    <tr>
        <th>Nombre de lignes (Fichier SEGUCE RDC)</th>
        <td><%= comparisonResult.summary.totalRows.fileB %></td>
    </tr>
    <tr>
        <th>Nombre de matricules contrôlés</th>
        <td><%= summary.matriculeCount || 0 %></td>
    </tr>
    <tr>
        <th>Présence de doublons</th>
        <td><%= summary.hasDuplicates ? 'OUI' : 'NON' %></td>
    </tr>
    <tr>
        <th>Nombre de différences</th>
        <td class="<%= summary.errorCount > 0 ? 'text-danger fw-bold' : '' %>">
            <%= summary.errorCount %>
        </td>
    </tr>
</tbody>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h4 class="text-primary mb-3">Actions</h4>
                                <div class="d-grid gap-2">
                                    <a href="/" class="btn btn-primary">
                                        <i class="bi bi-arrow-left me-2"></i>Retour à l'accueil
                                    </a>
                                    <button id="printBtn" class="btn btn-secondary">
                                        <i class="bi bi-printer me-2"></i>Imprimer les résultats
                                    </button>
                                    <a href="/export-excel" class="btn btn-success">
                                        <i class="bi bi-file-earmark-excel me-2"></i>Exporter en Excel
                                    </a>
                                </div>
                            </div>
                        </div>

                     

<h4 class="text-primary mb-3">Récapitulatif des écarts des données fixes</h4>
<div class="table-responsive">
    <table class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th scope="col">Rubrique</th>
                <th scope="col">Fichier prestataire paie</th>
                <th scope="col">Fichier SEGUCE</th>
                <th scope="col">Différence</th>
            </tr>
        </thead>
        <tbody>
            <!-- Éléments fixes -->
            <% const fixedElements = [
                "Matricule", "BU", "Pers. à Charge", "Enfant Légal", "Salaire mensuel",
                "Ancienneté mensuel", "Sur Salaire mensuel", "Taux horaire", 
                "Transport mensuel", "Logement mensuel", "Prime astreinte", 
                "Forfait heures supplémentaire", "Prime de détachement", "Prime Imposable Fixe"
            ]; %>
            
            <% fixedElements.forEach(element => { 
                // Rechercher l'élément dans les totaux
                const valueA = summary.totals.fileA[element] || 0;
                const valueB = summary.totals.fileB[element] || 0;
                const diff = valueA - valueB;
                const hasDiff = diff !== 0;
            %>
                <tr>
                    <th scope="row"><%= element %></th>
                    <td class="text-end"><%= valueA.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                    <td class="text-end"><%= valueB.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                    <td class="text-end <%= hasDiff ? 'text-danger' : '' %>">
                        <%= diff.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %>
                    </td>
                </tr>
            <% }); %>
        </tbody>
    </table>
</div>

<h4 class="text-primary mb-3">Récapitulatif des écarts des données variables</h4>
<div class="table-responsive">
    <table class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th scope="col">Rubrique</th>
                <th scope="col">Fichier prestataire paie</th>
                <th scope="col">Fichier SEGUCE</th>
                <th scope="col">Différence</th>
            </tr>
        </thead>
        <tbody>
            <!-- Éléments variables -->
            <% const variableElements = [
                "Jr. Prestés", "JAbsence", "Jrs. Maladie", "Congé Circ.", "Congé Maternité",
                "Jrs. Ferié", "Jrs. Congé Payés", "Nbre Heure Supp. 1", "Nbre Heure Supp. 2", 
                "Nbre Heure Supp. 3", "Heures de nuit 25%", "Regule sur congé", "Regule",
                "Prime de bonne conduite auto", "Prime de production", "Aide sociale",
                "Prime intérim", "13ème mois", "Pagne + frais de couture", "Prime migration IT",
                "Aide rentrée scolaire", "Bonus", "Prime de mariage", "Prime Audit",
                "Panier de fin d'année", "Autre prime", "Prime Imposable Variable"
            ]; %>
            
            <% variableElements.forEach(element => { 
                // Rechercher l'élément dans les totaux
                const valueA = summary.totals.fileA[element] || 0;
                const valueB = summary.totals.fileB[element] || 0;
                const diff = valueA - valueB;
                const hasDiff = diff !== 0;
            %>
                <tr>
                    <th scope="row"><%= element %></th>
                    <td class="text-end"><%= valueA.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                    <td class="text-end"><%= valueB.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                    <td class="text-end <%= hasDiff ? 'text-danger' : '' %>">
                        <%= diff.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %>
                    </td>
                </tr>
            <% }); %>
        </tbody>
    </table>
</div>

<h4 class="text-primary mb-3">Récapitulatif des charges</h4>
<div class="table-responsive">
    <table class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th scope="col">Rubrique</th>
                <th scope="col">Fichier prestataire paie</th>
                <th scope="col">Fichier SEGUCE</th>
                <th scope="col">Différence</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <th colspan="4" class="table-secondary">Charges salariales</th>
            </tr>
            <tr>
                <th scope="row">Cnss QPO</th>
                <td class="text-end"><%= summary.totals.fileA['Cnss QPO'].toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                <td class="text-end"><%= summary.totals.fileB['Cnss QPO'].toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                <td class="text-end <%= (summary.totals.fileA['Cnss QPO'] - summary.totals.fileB['Cnss QPO']) !== 0 ? 'text-danger' : '' %>">
                    <%= (summary.totals.fileA['Cnss QPO'] - summary.totals.fileB['Cnss QPO']).toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %>
                </td>
            </tr>
            <tr>
                <th scope="row">IPR</th>
                <td class="text-end"><%= summary.totals.fileA['IPR'].toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                <td class="text-end"><%= summary.totals.fileB['IPR'].toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                <td class="text-end <%= (summary.totals.fileA['IPR'] - summary.totals.fileB['IPR']) !== 0 ? 'text-danger' : '' %>">
                    <%= (summary.totals.fileA['IPR'] - summary.totals.fileB['IPR']).toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %>
                </td>
            </tr>
            <tr class="table-primary">
                <th scope="row">Total charges salariales</th>
                <td class="text-end fw-bold"><%= (summary.totals.fileA['Cnss QPO'] + summary.totals.fileA['IPR']).toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                <td class="text-end fw-bold"><%= (summary.totals.fileB['Cnss QPO'] + summary.totals.fileB['IPR']).toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                <td class="text-end fw-bold <%= ((summary.totals.fileA['Cnss QPO'] + summary.totals.fileA['IPR']) - (summary.totals.fileB['Cnss QPO'] + summary.totals.fileB['IPR'])) !== 0 ? 'text-danger' : '' %>">
                    <%= ((summary.totals.fileA['Cnss QPO'] + summary.totals.fileA['IPR']) - (summary.totals.fileB['Cnss QPO'] + summary.totals.fileB['IPR'])).toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %>
                </td>
            </tr>
            <tr>
                <th colspan="4" class="table-secondary">Charges patronales</th>
            </tr>
            <tr>
                <th scope="row">Cnss QPP</th>
                <td class="text-end"><%= summary.totals.fileA['Cnss QPP'].toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                <td class="text-end"><%= summary.totals.fileB['Cnss QPP'].toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                <td class="text-end <%= (summary.totals.fileA['Cnss QPP'] - summary.totals.fileB['Cnss QPP']) !== 0 ? 'text-danger' : '' %>">
                    <%= (summary.totals.fileA['Cnss QPP'] - summary.totals.fileB['Cnss QPP']).toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %>
                </td>
            </tr>
            <tr>
                <th scope="row">Inpp</th>
                <td class="text-end"><%= summary.totals.fileA['Inpp'].toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                <td class="text-end"><%= summary.totals.fileB['Inpp'].toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                <td class="text-end <%= (summary.totals.fileA['Inpp'] - summary.totals.fileB['Inpp']) !== 0 ? 'text-danger' : '' %>">
                    <%= (summary.totals.fileA['Inpp'] - summary.totals.fileB['Inpp']).toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %>
                </td>
            </tr>
            <tr>
                <th scope="row">Onem</th>
                <td class="text-end"><%= summary.totals.fileA['Onem'].toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                <td class="text-end"><%= summary.totals.fileB['Onem'].toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                <td class="text-end <%= (summary.totals.fileA['Onem'] - summary.totals.fileB['Onem']) !== 0 ? 'text-danger' : '' %>">
                    <%= (summary.totals.fileA['Onem'] - summary.totals.fileB['Onem']).toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %>
                </td>
            </tr>
            <tr class="table-primary">
                <th scope="row">Total charges patronales</th>
                <td class="text-end fw-bold"><%= summary.totals.fileA['Total Charge Patronale'].toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                <td class="text-end fw-bold"><%= summary.totals.fileB['Total Charge Patronale'].toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                <td class="text-end fw-bold <%= (summary.totals.fileA['Total Charge Patronale'] - summary.totals.fileB['Total Charge Patronale']) !== 0 ? 'text-danger' : '' %>">
                    <%= (summary.totals.fileA['Total Charge Patronale'] - summary.totals.fileB['Total Charge Patronale']).toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %>
                </td>
            </tr>
            <tr>
                <th colspan="4" class="table-secondary">Répartition des coûts liés aux salaires</th>
            </tr>
            <tr>
                <th scope="row">Coût Salarial</th>
                <td class="text-end"><%= summary.totals.fileA['Coût Salarial'].toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                <td class="text-end"><%= summary.totals.fileB['Coût Salarial'].toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                <td class="text-end <%= (summary.totals.fileA['Coût Salarial'] - summary.totals.fileB['Coût Salarial']) !== 0 ? 'text-danger' : '' %>">
                    <%= (summary.totals.fileA['Coût Salarial'] - summary.totals.fileB['Coût Salarial']).toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %>
                </td>
            </tr>
            <tr>
                <th scope="row">Masse Salariale</th>
                <td class="text-end"><%= summary.totals.fileA['Masse Salariale'].toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                <td class="text-end"><%= summary.totals.fileB['Masse Salariale'].toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                <td class="text-end <%= (summary.totals.fileA['Masse Salariale'] - summary.totals.fileB['Masse Salariale']) !== 0 ? 'text-danger' : '' %>">
                    <%= (summary.totals.fileA['Masse Salariale'] - summary.totals.fileB['Masse Salariale']).toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %>
                </td>
            </tr>
            <tr>
                <th scope="row">Net à Payer</th>
                <td class="text-end"><%= summary.totals.fileA['Net à Payer'].toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                <td class="text-end"><%= summary.totals.fileB['Net à Payer'].toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                <td class="text-end <%= (summary.totals.fileA['Net à Payer'] - summary.totals.fileB['Net à Payer']) !== 0 ? 'text-danger' : '' %>">
                    <%= (summary.totals.fileA['Net à Payer'] - summary.totals.fileB['Net à Payer']).toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %>
                </td>
            </tr>
            <tr>
                <th scope="row">Frais de Services</th>
                <td class="text-end"><%= summary.totals.fileA['Frais de Services'].toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                <td class="text-end"><%= summary.totals.fileB['Frais de Services'].toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                <td class="text-end <%= (summary.totals.fileA['Frais de Services'] - summary.totals.fileB['Frais de Services']) !== 0 ? 'text-danger' : '' %>">
                    <%= (summary.totals.fileA['Frais de Services'] - summary.totals.fileB['Frais de Services']).toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %>
                </td>
            </tr>
            <tr>
                <th scope="row">TVA 16% Frais Services</th>
                <td class="text-end"><%= summary.totals.fileA['TVA 16% Frais Services'].toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                <td class="text-end"><%= summary.totals.fileB['TVA 16% Frais Services'].toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                <td class="text-end <%= (summary.totals.fileA['TVA 16% Frais Services'] - summary.totals.fileB['TVA 16% Frais Services']) !== 0 ? 'text-danger' : '' %>">
                    <%= (summary.totals.fileA['TVA 16% Frais Services'] - summary.totals.fileB['TVA 16% Frais Services']).toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %>
                </td>
            </tr>
        </tbody>
    </table>
</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h3 class="card-title mb-0">Résumé des différences</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card text-center mb-3">
                                    <div class="card-body">
                                        <h5 class="card-title">Nombre total de différences</h5>
                                        <h2 class="text-danger"><%= comparisonResult.summary.totalDifferences %></h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center mb-3">
                                    <div class="card-body">
                                        <h5 class="card-title">Lignes Fichier Fournisseur</h5>
                                        <h2 class="text-primary"><%= comparisonResult.summary.totalRows.fileA %></h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center mb-3">
                                    <div class="card-body">
                                        <h5 class="card-title">Lignes Fichier SEGUCE RDC</h5>
                                        <h2 class="text-secondary"><%= comparisonResult.summary.totalRows.fileB %></h2>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Début ajout -->
                         

<% if (comparisonResult.summary.columnStats.missingInA.length > 0 || comparisonResult.summary.columnStats.missingInB.length > 0) { %>
    <h4 class="mt-4 text-primary">Colonnes non correspondantes</h4>
    <div class="alert alert-warning">
        <p><strong>La comparaison sera effectuée uniquement sur les colonnes communes.</strong></p>
        
        <% if (comparisonResult.summary.columnStats.missingInA.length > 0) { %>
            <div class="mb-2">
                <h6>Colonnes présentes uniquement dans SEGUCE RDC (<%= comparisonResult.summary.columnStats.missingInA.length %>):</h6>
                <ul class="ps-3">
                    <% comparisonResult.summary.columnStats.missingInA.forEach(col => { %>
                        <li><span class="badge bg-primary text-wrap"><%= col %></span></li>
                    <% }) %>
                </ul>
            </div>
        <% } %>
        
        <% if (comparisonResult.summary.columnStats.missingInB.length > 0) { %>
            <div class="mb-2">
                <h6>Colonnes présentes uniquement dans le Fichier Fournisseur (<%= comparisonResult.summary.columnStats.missingInB.length %>):</h6>
                <ul class="ps-3">
                    <% comparisonResult.summary.columnStats.missingInB.forEach(col => { %>
                        <li><span class="badge bg-secondary text-wrap"><%= col %></span></li>
                    <% }) %>
                </ul>
            </div>
        <% } %>
        
        <p class="mb-0">Nombre de colonnes communes utilisées pour la comparaison: <strong><%= comparisonResult.summary.columnStats.commonColumns.length %></strong></p>
    </div>
<% } %>

<% if (comparisonResult.hasDuplicates) { %>
    <h4 class="mt-4 text-primary">Doublons de matricules détectés</h4>
    
    <% if (comparisonResult.summary.duplicates.fileA.length > 0) { %>
        <div class="alert alert-danger mb-3">
            <h5><i class="bi bi-exclamation-triangle-fill me-2"></i>Doublons dans le Fichier Fournisseur</h5>
            <% comparisonResult.summary.duplicates.fileA.forEach(dup => { %>
                <div class="mb-2">
                    <strong>Matricule: <%= dup.matricule %></strong>
                    <span class="badge bg-danger ms-2"><%= dup.count %> occurrences</span>
                    <p class="mb-0 ms-4">Présent aux lignes: <%= dup.rows.join(', ') %></p>
                </div>
            <% }) %>
        </div>
    <% } %>
    
    <% if (comparisonResult.summary.duplicates.fileB.length > 0) { %>
        <div class="alert alert-danger mb-3">
            <h5><i class="bi bi-exclamation-triangle-fill me-2"></i>Doublons dans le Fichier SEGUCE RDC</h5>
            <% comparisonResult.summary.duplicates.fileB.forEach(dup => { %>
                <div class="mb-2">
                    <strong>Matricule: <%= dup.matricule %></strong>
                    <span class="badge bg-danger ms-2"><%= dup.count %> occurrences</span>
                    <p class="mb-0 ms-4">Présent aux lignes: <%= dup.rows.join(', ') %></p>
                </div>
            <% }) %>
        </div>
    <% } %>
<% } %>
                         <!-- Fin ajout -->

                        <% if (comparisonResult.summary.columnDifferences.length > 0) { %>
                            <!-- <h4 class="mt-4">Différences par colonne</h4>
                            <div class="input-group mb-3">
                                <span class="input-group-text">Rechercher</span>
                                <input type="text" class="form-control" id="searchColumns" placeholder="Filtrer les colonnes...">
                            </div> -->
                            <!-- <div class="table-responsive">
                                <table class="table table-striped table-hover" id="columnsTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Colonne</th>
                                            <th>Nombre de différences</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% comparisonResult.summary.columnDifferences.forEach(colDiff => { %>
                                            <tr>
                                                <td><%= colDiff.column %></td>
                                                <td><span class="badge bg-danger"><%= colDiff.count %></span></td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary filter-btn" data-column="<%= colDiff.column %>">
                                                        <i class="bi bi-filter"></i> Filtrer les différences
                                                    </button>
                                                </td>
                                            </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div> -->
                        <% } else { %>
                            <div class="alert alert-success mt-4">
                                <i class="bi bi-check-circle-fill me-2"></i>
                                Aucune différence n'a été trouvée dans les colonnes communes.
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>

<h4 class="mt-4 text-primary">Analyse séquentielle</h4>

<!-- MODIFICATION ICI: Ajout des vérifications conditionnelles complètes -->
<% if (comparisonResult.summary && comparisonResult.summary.sequentialComparison && comparisonResult.summary.sequentialComparison.fixedElements && comparisonResult.summary.sequentialComparison.fixedElements.totalErrors > 0) { %>
    <div class="alert alert-danger">
        <h5><i class="bi bi-exclamation-triangle-fill me-2"></i>Erreurs détectées dans les éléments fixes</h5>
        <p>Des incohérences ont été trouvées dans les données qui devraient être stables. Il est recommandé de vérifier ces erreurs avant de continuer.</p>
        
        <table class="table table-sm table-bordered mt-3">
            <thead>
                <tr>
                    <th>Colonne</th>
                    <th>Nombre d'erreurs</th>
                </tr>
            </thead>
            <tbody>
                <% comparisonResult.summary.sequentialComparison.fixedElements.columnsWithErrors.forEach(col => { %>
                    <tr>
                        <td><%= col.column %></td>
                        <td><span class="badge bg-danger"><%= col.errorCount %></span></td>
                    </tr>
                <% }); %>
            </tbody>
        </table>
    </div>
<% } else { %>
    <div class="alert alert-success">
        <i class="bi bi-check-circle-fill me-2"></i>
        Tous les éléments fixes correspondent !
    </div>
<% } %>

<div class="mt-3">
    <h6>Résumé de l'analyse:</h6>
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-body">
                    <h6 class="card-title">Éléments fixes</h6>
                    <p class="card-text">
                        <!-- MODIFICATION ICI: Ajout des vérifications conditionnelles pour les propriétés -->
                        <strong><%= comparisonResult.summary && comparisonResult.summary.sequentialComparison && comparisonResult.summary.sequentialComparison.fixedElements ? comparisonResult.summary.sequentialComparison.fixedElements.totalColumns : 0 %></strong> colonnes vérifiées
                        <br>
                        <strong><%= comparisonResult.summary && comparisonResult.summary.sequentialComparison && comparisonResult.summary.sequentialComparison.fixedElements ? comparisonResult.summary.sequentialComparison.fixedElements.totalErrors : 0 %></strong> erreurs trouvées
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-body">
                    <h6 class="card-title">Éléments variables</h6>
                    <p class="card-text">
                        <!-- MODIFICATION ICI: Ajout des vérifications conditionnelles pour les propriétés -->
                        <strong><%= comparisonResult.summary && comparisonResult.summary.sequentialComparison && comparisonResult.summary.sequentialComparison.variableElements ? comparisonResult.summary.sequentialComparison.variableElements.totalColumns : 0 %></strong> colonnes vérifiées
                        <br>
                        <strong><%= comparisonResult.summary && comparisonResult.summary.sequentialComparison && comparisonResult.summary.sequentialComparison.variableElements ? comparisonResult.summary.sequentialComparison.variableElements.totalErrors : 0 %></strong> erreurs trouvées
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
        <div class="row">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h3 class="card-title mb-0">Détails des différences</h3>
                        <div>
                            <div class="input-group">
                                <input type="text" class="form-control form-control-sm" id="searchResults" placeholder="Rechercher dans les résultats...">
                                <button class="btn btn-light btn-sm" id="clearFilterBtn">
                                    <i class="bi bi-x-circle"></i> Effacer
                                </button>
                                <button class="btn btn-light btn-sm" id="expandAllBtn">
                                    <i class="bi bi-arrows-expand"></i> Tout développer
                                </button>
                                <button class="btn btn-light btn-sm" id="collapseAllBtn">
                                    <i class="bi bi-arrows-collapse"></i> Tout réduire
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Remplacez la section accordéon existante par : -->
<% if (comparisonResult.details.length > 0) { %>
    <div class="accordion" id="differencesAccordion">
        <% comparisonResult.details.forEach((detail, index) => { %>
            <div class="accordion-item" data-matricule="<%= detail.id %>" data-columns="<%= detail.differences ? detail.differences.map(d => d.column).join(',') : '' %>">
                <h2 class="accordion-header" id="heading<%= index %>">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse<%= index %>" aria-expanded="false" aria-controls="collapse<%= index %>">
                        <div class="d-flex justify-content-between w-100">
                            <span>
                                <% if (detail.onlyInFileA) { %>
                                    <span class="badge bg-warning me-2">Uniquement dans Fichier Fournisseur</span>
                                <% } else if (detail.onlyInFileB) { %>
                                    <span class="badge bg-info me-2">Uniquement dans Fichier SEGUCE RDC</span>
                                <% } else { %>
                                    <span class="badge bg-danger me-2"><%= detail.differences.length %> différence(s)</span>
                                <% } %>
                                <strong>Matricule: <%= detail.id %></strong>
                            </span>
                        </div>
                    </button>
                </h2>
                <div id="collapse<%= index %>" class="accordion-collapse collapse" aria-labelledby="heading<%= index %>" data-bs-parent="#differencesAccordion">
                    <div class="accordion-body">
                        <% if (detail.onlyInFileA) { %>
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                <strong>Cette entrée existe uniquement dans le Fichier Fournisseur</strong>
                            </div>
                        <% } else if (detail.onlyInFileB) { %>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle-fill me-2"></i>
                                <strong>Cette entrée existe uniquement dans le Fichier SEGUCE RDC</strong>
                            </div>
                        <% } %>
                        
                        <% if (detail.onlyInFileA || detail.onlyInFileB) { %>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Colonne</th>
                                            <th>Valeur</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% Object.entries(detail.rowData).forEach(([key, value]) => { %>
                                            <tr>
                                                <td><strong><%= key %></strong></td>
                                                <td><%= value %></td>
                                            </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                       <% } else { %>
    <% if (detail.differences.length > 0) { %>
        <% if (detail.categorizedDifferences && (detail.categorizedDifferences.fixed.length > 0 || detail.categorizedDifferences.variable.length > 0)) { %>
            <% if (detail.categorizedDifferences.fixed.length > 0) { %>
                <h6 class="mt-3 text-danger">Éléments fixes avec différences (<%= detail.categorizedDifferences.fixed.length %>)</h6>
                <div class="table-responsive">
                    <table class="table table-striped table-hover border-danger">
                        <thead class="table-danger">
                            <tr>
                                <th>Colonne</th>
                                <th>Fichier Fournisseur</th>
                                <th>Fichier SEGUCE RDC</th>
                                <th>Différence</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% detail.categorizedDifferences.fixed.forEach(diff => { %>
                                <tr class="diff-row" data-column="<%= diff.column %>">
                                    <td><strong><%= diff.column %></strong></td>
                                    <td class="bg-light">
                                        <% if (diff.isNumeric) { %>
                                            <span class="text-primary fw-bold"><%= typeof diff.valueA === 'number' ? diff.valueA.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : diff.valueA %></span>
                                        <% } else { %>
                                            <span class="text-primary"><%= diff.valueA %></span>
                                        <% } %>
                                    </td>
                                    <td class="bg-light">
                                        <% if (diff.isNumeric) { %>
                                            <span class="text-secondary fw-bold"><%= typeof diff.valueB === 'number' ? diff.valueB.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : diff.valueB %></span>
                                        <% } else { %>
                                            <span class="text-secondary"><%= diff.valueB %></span>
                                        <% } %>
                                    </td>
                                    <td>
                                        <% if (typeof diff.difference === 'number') { %>
                                            <% if (diff.difference > 0) { %>
                                                <span class="text-danger fw-bold">+<%= diff.difference.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></span>
                                            <% } else { %>
                                                <span class="text-danger fw-bold"><%= diff.difference.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></span>
                                            <% } %>
                                        <% } else { %>
                                            <span class="text-danger fw-bold"><%= diff.difference %></span>
                                        <% } %>
                                    </td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
            <% } %>
            
            <% if (detail.categorizedDifferences.variable.length > 0) { %>
                <h6 class="mt-3">Éléments variables avec différences (<%= detail.categorizedDifferences.variable.length %>)</h6>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Colonne</th>
                                <th>Fichier Fournisseur</th>
                                <th>Fichier SEGUCE RDC</th>
                                <th>Différence</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% detail.categorizedDifferences.variable.forEach(diff => { %>
                                <tr class="diff-row" data-column="<%= diff.column %>">
                                    <td><strong><%= diff.column %></strong></td>
                                    <td class="bg-light">
                                        <% if (diff.isNumeric) { %>
                                            <span class="text-primary fw-bold"><%= typeof diff.valueA === 'number' ? diff.valueA.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : diff.valueA %></span>
                                        <% } else { %>
                                            <span class="text-primary"><%= diff.valueA %></span>
                                        <% } %>
                                    </td>
                                    <td class="bg-light">
                                        <% if (diff.isNumeric) { %>
                                            <span class="text-secondary fw-bold"><%= typeof diff.valueB === 'number' ? diff.valueB.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : diff.valueB %></span>
                                        <% } else { %>
                                            <span class="text-secondary"><%= diff.valueB %></span>
                                        <% } %>
                                    </td>
                                    <td>
                                        <% if (typeof diff.difference === 'number') { %>
                                            <% if (diff.difference > 0) { %>
                                                <span class="text-danger fw-bold">+<%= diff.difference.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></span>
                                            <% } else { %>
                                                <span class="text-danger fw-bold"><%= diff.difference.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></span>
                                            <% } %>
                                        <% } else { %>
                                            <span class="text-danger fw-bold"><%= diff.difference %></span>
                                        <% } %>
                                    </td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
            <% } %>
        <% } else { %>
            <!-- Fallback si la catégorisation n'est pas disponible -->
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Colonne</th>
                            <th>Fichier Fournisseur</th>
                            <th>Fichier SEGUCE RDC</th>
                            <th>Différence</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% detail.differences.forEach(diff => { %>
                            <tr class="diff-row" data-column="<%= diff.column %>">
                                <td><strong><%= diff.column %></strong></td>
                                <td class="bg-light">
                                    <% if (diff.isNumeric) { %>
                                        <span class="text-primary fw-bold"><%= typeof diff.valueA === 'number' ? diff.valueA.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : diff.valueA %></span>
                                    <% } else { %>
                                        <span class="text-primary"><%= diff.valueA %></span>
                                    <% } %>
                                </td>
                                <td class="bg-light">
                                    <% if (diff.isNumeric) { %>
                                        <span class="text-secondary fw-bold"><%= typeof diff.valueB === 'number' ? diff.valueB.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : diff.valueB %></span>
                                    <% } else { %>
                                        <span class="text-secondary"><%= diff.valueB %></span>
                                    <% } %>
                                </td>
                                <td>
                                    <% if (typeof diff.difference === 'number') { %>
                                        <% if (diff.difference > 0) { %>
                                            <span class="text-danger fw-bold">+<%= diff.difference.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></span>
                                        <% } else { %>
                                            <span class="text-danger fw-bold"><%= diff.difference.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></span>
                                        <% } %>
                                    <% } else { %>
                                        <span class="text-danger fw-bold"><%= diff.difference %></span>
                                    <% } %>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        <% } %>
    <% } %>
<% } %>
                    </div>
                </div>
            </div>
        <% }); %>
    </div>
<% } else { %>
    <div class="alert alert-success">
        <i class="bi bi-check-circle-fill me-2"></i>
        Aucune différence n'a été détectée entre les deux fichiers.
    </div>
<% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <%- include('partials/footer') %>

    <script>
        // Fonctionnalité d'expansion/réduction des accordéons
        document.getElementById('expandAllBtn').addEventListener('click', function() {
            document.querySelectorAll('.accordion-button').forEach(button => {
                if (button.classList.contains('collapsed')) {
                    button.click();
                }
            });
        });

        document.getElementById('collapseAllBtn').addEventListener('click', function() {
            document.querySelectorAll('.accordion-button').forEach(button => {
                if (!button.classList.contains('collapsed')) {
                    button.click();
                }
            });
        });

        // Fonctionnalité d'impression
        document.getElementById('printBtn').addEventListener('click', function() {
            window.print();
        });
        
        // Fonctionnalité de recherche dans les résultats
        document.getElementById('searchResults').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            document.querySelectorAll('.accordion-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });

        // Filtrage par colonne
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const column = this.getAttribute('data-column');
                const searchInput = document.getElementById('searchResults');
                searchInput.value = '';  // Réinitialiser la recherche globale
                
                // Montrer uniquement les éléments avec cette colonne
                document.querySelectorAll('.accordion-item').forEach(item => {
                    const columns = item.getAttribute('data-columns').split(',');
                    item.style.display = columns.includes(column) ? '' : 'none';
                });
                
                // Développer tous les éléments visibles
                document.querySelectorAll('.accordion-item:not([style*="display: none"]) .accordion-button.collapsed').forEach(button => {
                    button.click();
                });
            });
        });

        // Effacer les filtres
        document.getElementById('clearFilterBtn').addEventListener('click', function() {
            document.getElementById('searchResults').value = '';
            document.querySelectorAll('.accordion-item').forEach(item => {
                item.style.display = '';
            });
        });

        // Recherche dans les colonnes
        document.getElementById('searchColumns').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const tableRows = document.querySelectorAll('#columnsTable tbody tr');
            
            tableRows.forEach(row => {
                const columnName = row.querySelector('td:first-child').textContent.toLowerCase();
                row.style.display = columnName.includes(searchTerm) ? '' : 'none';
            });
        });
    </script>
</body>
</html>