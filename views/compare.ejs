<!DOCTYPE html>
<html lang="fr">
<head>
    <%- include('partials/header') %>
    <title><%= title %></title>
</head>
<body>
    <div class="container-fluid">
        <header class="my-4 text-center">
            <h1><%= title %></h1>
            <p class="lead">Résultats de la réconciliation entre les fichiers</p>
            <div class="d-flex justify-content-center">
                <span class="badge bg-primary me-2">Fichier A: <%= fileAName %></span>
                <span class="badge bg-secondary">Fichier B: <%= fileBName %></span>
            </div>
        </header>

        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h3 class="card-title mb-0">Résumé des différences</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card text-center mb-3">
                                    <div class="card-body">
                                        <h5 class="card-title">Nombre total de différences</h5>
                                        <h2 class="text-danger"><%= comparisonResult.summary.totalDifferences %></h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center mb-3">
                                    <div class="card-body">
                                        <h5 class="card-title">Lignes Fichier A</h5>
                                        <h2 class="text-primary"><%= comparisonResult.summary.totalRows.fileA %></h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center mb-3">
                                    <div class="card-body">
                                        <h5 class="card-title">Lignes Fichier B</h5>
                                        <h2 class="text-secondary"><%= comparisonResult.summary.totalRows.fileB %></h2>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <% if (comparisonResult.summary.columnDifferences.length > 0) { %>
                            <h4 class="mt-4">Différences par colonne</h4>
                            <div class="input-group mb-3">
                                <span class="input-group-text">Rechercher</span>
                                <input type="text" class="form-control" id="searchColumns" placeholder="Filtrer les colonnes...">
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="columnsTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Colonne</th>
                                            <th>Nombre de différences</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% comparisonResult.summary.columnDifferences.forEach(colDiff => { %>
                                            <tr>
                                                <td><%= colDiff.column %></td>
                                                <td><span class="badge bg-danger"><%= colDiff.count %></span></td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary filter-btn" data-column="<%= colDiff.column %>">
                                                        <i class="bi bi-filter"></i> Filtrer les différences
                                                    </button>
                                                </td>
                                            </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                        <% } else { %>
                            <div class="alert alert-success mt-4">
                                <i class="bi bi-check-circle-fill me-2"></i>
                                Aucune différence n'a été trouvée dans les colonnes communes.
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h3 class="card-title mb-0">Détails des différences</h3>
                        <div>
                            <div class="input-group">
                                <input type="text" class="form-control form-control-sm" id="searchResults" placeholder="Rechercher dans les résultats...">
                                <button class="btn btn-light btn-sm" id="clearFilterBtn">
                                    <i class="bi bi-x-circle"></i> Effacer
                                </button>
                                <button class="btn btn-light btn-sm" id="expandAllBtn">
                                    <i class="bi bi-arrows-expand"></i> Tout développer
                                </button>
                                <button class="btn btn-light btn-sm" id="collapseAllBtn">
                                    <i class="bi bi-arrows-collapse"></i> Tout réduire
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <% if (comparisonResult.details.length > 0) { %>
                            <div class="accordion" id="differencesAccordion">
                                <% comparisonResult.details.forEach((detail, index) => { %>
                                    <div class="accordion-item" data-matricule="<%= detail.id %>" data-columns="<%= detail.differences ? detail.differences.map(d => d.column).join(',') : '' %>">
                                        <h2 class="accordion-header" id="heading<%= index %>">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse<%= index %>" aria-expanded="false" aria-controls="collapse<%= index %>">
                                                <div class="d-flex justify-content-between w-100">
                                                    <span>
                                                        <% if (detail.onlyInFileA) { %>
                                                            <span class="badge bg-warning me-2">Uniquement dans Fichier A</span>
                                                        <% } else if (detail.onlyInFileB) { %>
                                                            <span class="badge bg-info me-2">Uniquement dans Fichier B</span>
                                                        <% } else { %>
                                                            <span class="badge bg-danger me-2"><%= detail.differences.length %> différence(s)</span>
                                                        <% } %>
                                                        Matricule: <%= detail.id %>
                                                    </span>
                                                </div>
                                            </button>
                                        </h2>
                                        <div id="collapse<%= index %>" class="accordion-collapse collapse" aria-labelledby="heading<%= index %>" data-bs-parent="#differencesAccordion">
                                            <div class="accordion-body">
                                                <% if (detail.onlyInFileA || detail.onlyInFileB) { %>
                                                    <div class="alert alert-warning">
                                                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                                        <strong>
                                                            <% if (detail.onlyInFileA) { %>
                                                                Cette entrée existe uniquement dans le Fichier A (Entreprise)
                                                            <% } else { %>
                                                                Cette entrée existe uniquement dans le Fichier B (Client)
                                                            <% } %>
                                                        </strong>
                                                    </div>
                                                    <div class="table-responsive">
                                                        <table class="table table-sm table-bordered">
                                                            <thead class="table-light">
                                                                <tr>
                                                                    <th>Colonne</th>
                                                                    <th>Valeur</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <% Object.entries(detail.rowData).forEach(([key, value]) => { %>
                                                                    <tr>
                                                                        <td><strong><%= key %></strong></td>
                                                                        <td><%= value %></td>
                                                                    </tr>
                                                                <% }); %>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                <% } else { %>
                                                    <div class="table-responsive">
                                                        <table class="table table-striped table-hover">
                                                            <thead class="table-dark">
                                                                <tr>
                                                                    <th>Colonne</th>
                                                                    <th>Fichier A (Entreprise)</th>
                                                                    <th>Fichier B (Client)</th>
                                                                    <th>Différence</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <% detail.differences.forEach(diff => { %>
                                                                    <tr class="diff-row" data-column="<%= diff.column %>">
                                                                        <td>
                                                                            <strong><%= diff.column %></strong>
                                                                        </td>
                                                                        <td class="bg-light">
                                                                            <% if (diff.isNumeric) { %>
                                                                                <span class="text-primary fw-bold"><%= typeof diff.valueA === 'number' ? diff.valueA.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : diff.valueA %></span>
                                                                            <% } else { %>
                                                                                <span class="text-primary"><%= diff.valueA %></span>
                                                                            <% } %>
                                                                        </td>
                                                                        <td class="bg-light">
                                                                            <% if (diff.isNumeric) { %>
                                                                                <span class="text-secondary fw-bold"><%= typeof diff.valueB === 'number' ? diff.valueB.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : diff.valueB %></span>
                                                                            <% } else { %>
                                                                                <span class="text-secondary"><%= diff.valueB %></span>
                                                                            <% } %>
                                                                        </td>
                                                                        <td>
                                                                            <% if (typeof diff.difference === 'number') { %>
                                                                                <% if (diff.difference > 0) { %>
                                                                                    <span class="text-danger fw-bold">+<%= diff.difference.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></span>
                                                                                <% } else { %>
                                                                                    <span class="text-danger fw-bold"><%= diff.difference.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></span>
                                                                                <% } %>
                                                                            <% } else { %>
                                                                                <span class="text-danger fw-bold"><%= diff.difference %></span>
                                                                            <% } %>
                                                                        </td>
                                                                    </tr>
                                                                <% }); %>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                <% } %>
                                            </div>
                                        </div>
                                    </div>
                                <% }); %>
                            </div>
                        <% } else { %>
                            <div class="alert alert-success">
                                <i class="bi bi-check-circle-fill me-2"></i>
                                Aucune différence n'a été détectée entre les deux fichiers.
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4 text-center mb-5">
            <a href="/" class="btn btn-primary btn-lg">
                <i class="bi bi-arrow-left me-2"></i>Retour à l'accueil
            </a>
            <button id="printBtn" class="btn btn-success btn-lg ms-2">
                <i class="bi bi-printer me-2"></i>Imprimer les résultats
            </button>
            <button id="exportBtn" class="btn btn-info btn-lg ms-2">
                <i class="bi bi-file-earmark-excel me-2"></i>Exporter en Excel
            </button>
        </div>
    </div>

    <%- include('partials/footer') %>

    <script>
        // Fonctionnalité d'expansion/réduction des accordéons
        document.getElementById('expandAllBtn').addEventListener('click', function() {
            document.querySelectorAll('.accordion-button').forEach(button => {
                if (button.classList.contains('collapsed')) {
                    button.click();
                }
            });
        });

        document.getElementById('collapseAllBtn').addEventListener('click', function() {
            document.querySelectorAll('.accordion-button').forEach(button => {
                if (!button.classList.contains('collapsed')) {
                    button.click();
                }
            });
        });

        // Fonctionnalité d'impression
        document.getElementById('printBtn').addEventListener('click', function() {
            window.print();
        });

        // Fonctionnalité de recherche dans les résultats
        document.getElementById('searchResults').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            document.querySelectorAll('.accordion-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });

        // Filtrage par colonne
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const column = this.getAttribute('data-column');
                const searchInput = document.getElementById('searchResults');
                searchInput.value = '';  // Réinitialiser la recherche globale
                
                // Montrer uniquement les éléments avec cette colonne
                document.querySelectorAll('.accordion-item').forEach(item => {
                    const columns = item.getAttribute('data-columns').split(',');
                    item.style.display = columns.includes(column) ? '' : 'none';
                });
                
                // Développer tous les éléments visibles
                document.querySelectorAll('.accordion-item:not([style*="display: none"]) .accordion-button.collapsed').forEach(button => {
                    button.click();
                });
            });
        });

        // Effacer les filtres
        document.getElementById('clearFilterBtn').addEventListener('click', function() {
            document.getElementById('searchResults').value = '';
            document.querySelectorAll('.accordion-item').forEach(item => {
                item.style.display = '';
            });
        });

        // Recherche dans les colonnes
        document.getElementById('searchColumns').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const tableRows = document.querySelectorAll('#columnsTable tbody tr');
            
            tableRows.forEach(row => {
                const columnName = row.querySelector('td:first-child').textContent.toLowerCase();
                row.style.display = columnName.includes(searchTerm) ? '' : 'none';
            });
        });
    </script>
</body>
</html>