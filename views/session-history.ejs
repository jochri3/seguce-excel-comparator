<!DOCTYPE html>
<html lang="fr">
  <head>
    <%- include('partials/header') %>
    <title><%= title %></title>
  </head>
  <body>
    <div class="container">
      <header class="my-4">
        <h1>Session <%= sessionId %></h1>
        <a href="/history" class="btn btn-secondary mb-3">
          <i class="bi bi-arrow-left me-2"></i>Retour à l'historique
        </a>
      </header>

      <div class="row">
        <div class="col-md-6">
          <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white">
              <h4 class="card-title mb-0">Fichiers Fournisseur</h4>
            </div>
            <div class="card-body">
              <% if (groupedFiles.fileA.length > 0) { %>
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Version</th>
                    <th>Nom du fichier</th>
                    <th>Date</th>
                    <th>Par</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% groupedFiles.fileA.forEach(file => { %>
                  <tr>
                    <td>v<%= file.version %></td>
                    <td><%= file.file_name %></td>
                    <td><%= new Date(file.created_at).toLocaleString() %></td>
                    <td><%= file.created_by %></td>
                    <td>
                      <a href="/history/view-file/<%= sessionId %>/<%= file.file_type %>/<%= file.version %>" class="btn btn-sm btn-outline-primary" title="Voir le fichier">
                        <i class="bi bi-eye"></i>
                      </a>
                      <% if (groupedFiles.fileA.length > 1 && file.version > 1) { %>
                        <a href="/history/compare-versions/<%= sessionId %>/fileA/<%= file.version - 1 %>/<%= file.version %>" class="btn btn-sm btn-outline-info" title="Comparer avec version précédente">
                          <i class="bi bi-arrow-left-right"></i>
                        </a>
                      <% } %>
                    </td>
                  </tr>
                  <% }) %>
                </tbody>
              </table>
              <% } else { %>
              <p class="text-muted">Aucun fichier fournisseur uploadé</p>
              <% } %>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card shadow mb-4">
            <div class="card-header bg-secondary text-white">
              <h4 class="card-title mb-0">Fichiers SEGUCE RDC</h4>
            </div>
            <div class="card-body">
              <% if (groupedFiles.fileB.length > 0) { %>
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Version</th>
                    <th>Nom du fichier</th>
                    <th>Date</th>
                    <th>Par</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% groupedFiles.fileB.forEach(file => { %>
                  <tr>
                    <td>v<%= file.version %></td>
                    <td><%= file.file_name %></td>
                    <td><%= new Date(file.created_at).toLocaleString() %></td>
                    <td><%= file.created_by %></td>
                    <td>
                      <a href="/history/view-file/<%= sessionId %>/<%= file.file_type %>/<%= file.version %>" class="btn btn-sm btn-outline-primary" title="Voir le fichier">
                        <i class="bi bi-eye"></i>
                      </a>
                      <% if (groupedFiles.fileB.length > 1 && file.version > 1) { %>
                        <a href="/history/compare-versions/<%= sessionId %>/fileB/<%= file.version - 1 %>/<%= file.version %>" class="btn btn-sm btn-outline-info" title="Comparer avec version précédente">
                          <i class="bi bi-arrow-left-right"></i>
                        </a>
                      <% } %>
                    </td>
                  </tr>
                  <% }) %>
                </tbody>
              </table>
              <% } else { %>
              <p class="text-muted">Aucun fichier SEGUCE RDC uploadé</p>
              <% } %>
            </div>
          </div>
        </div>
      </div>

      <!-- Section des résultats de réconciliation -->
      <div class="row">
        <div class="col-12">
          <div class="card shadow">
            <div class="card-header bg-info text-white">
              <h4 class="card-title mb-0">Résultats de réconciliation</h4>
            </div>
            <div class="card-body">
              <% if (comparisonResults && comparisonResults.length > 0) { %>
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Version</th>
                      <th>Différences trouvées</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% comparisonResults.forEach(result => { %>
                      <tr>
                        <td><%= new Date(result.created_at).toLocaleString() %></td>
                        <td>v<%= result.version %></td>
                        <td>
                          <span class="badge bg-<%= result.total_differences > 0 ? 'danger' : 'success' %>">
                            <%= result.total_differences %> différences
                          </span>
                        </td>
                        <td>
                          <a href="/history/view-comparison/<%= sessionId %>/<%= result.version %>" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-eye"></i> Voir détails
                          </a>
                        </td>
                      </tr>
                    <% }); %>
                  </tbody>
                </table>
              <% } else { %>
                <div class="alert alert-info">
                  <i class="bi bi-info-circle me-2"></i> Aucun résultat de réconciliation disponible pour cette session.
                </div>
              <% } %>

              <!-- Option pour comparer différentes versions -->
              <% if ((groupedFiles.fileA.length > 0 && groupedFiles.fileB.length > 0) && 
                    (groupedFiles.fileA.length > 1 || groupedFiles.fileB.length > 1)) { %>
                <div class="card mt-4">
                  <div class="card-header bg-light">
                    <h5 class="mb-0">Comparer les versions</h5>
                  </div>
                  <div class="card-body">
                    <form action="/history/compare-custom/<%= sessionId %>" method="GET" class="row g-3">
                      <div class="col-md-5">
                        <label class="form-label">Fichier Fournisseur</label>
                        <select name="fileA_version" class="form-select">
                          <% groupedFiles.fileA.forEach(file => { %>
                            <option value="<%= file.version %>">v<%= file.version %> - <%= file.file_name %></option>
                          <% }); %>
                        </select>
                      </div>
                      <div class="col-md-5">
                        <label class="form-label">Fichier SEGUCE RDC</label>
                        <select name="fileB_version" class="form-select">
                          <% groupedFiles.fileB.forEach(file => { %>
                            <option value="<%= file.version %>">v<%= file.version %> - <%= file.file_name %></option>
                          <% }); %>
                        </select>
                      </div>
                      <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">Comparer</button>
                      </div>
                    </form>
                  </div>
                </div>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <%- include('partials/footer') %>
  </body>
</html>